<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <title>Ternary Plot Survey with Supabase Login</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <!-- Load Plotly for Ternary Plot visualization -->
Â  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
Â  <!-- Load Supabase client -->
Â  <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        button:hover {
            transform: translateY(-1px);
        }
        /* Login/Submit buttons */
        button:not(#export-button) {
            background-color: #007bff; 
            color: white;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
        }
        button:not(#export-button):active {
            background-color: #0056b3;
        }
        /* Admin Export button */
        #export-button {
            background-color: #28a745; /* Green */
            color: white;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
            display: none; /* HIDE BY DEFAULT */
        }
        #export-button:active {
            background-color: #1e7e34;
        }
        #auth-status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #555;
            font-weight: 500;
        }
        .plot-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        @media (min-width: 1024px) {
            .plot-group {
                display: flex;
                justify-content: space-around;
            }
            .plot-section {
                width: 48%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
Â  <h1>Ternary Plot Survey</h1>
Â  <p>
Â  Â  Please indicate the relative importance (summing to 100%) of
Â  Â  <b>Corporate Rights</b>, <b>Human Rights</b>, and <b>Environmental Rights</b> for the scenario below.
Â  Â  You must log in before submitting your responses.
Â  </p>

    <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #fff8e1;">
        <button onclick="signIn()">Login with Email</button>
        <p id="auth-status">Not logged in</p>
        <!-- This button is only shown if the user's email matches the ADMIN_EMAIL in the script -->
        <button id="export-button" onclick="exportToExcel()">Export All Responses to CSV (Excel)</button>
    </div>

    <div class="plot-group">
        <!-- Present Day Plot -->
        <div class="plot-section">
            <h2>Present Day Values</h2>
            <div id="plot-present" style="width:100%; max-width:600px; height:600px;"></div>
            <p id="result-present" style="font-weight:bold; margin-top: 15px; color: #007bff;"></p>
            <button onclick="submitResponse('present')">Submit Present Response</button>
        </div>

        <!-- Future Plot -->
        <div class="plot-section">
            <h2>Values in 2075</h2>
            <div id="plot-future" style="width:100%; max-width:600px; height:600px;"></div>
            <p id="result-future" style="font-weight:bold; margin-top: 15px; color: #007bff;"></p>
            <button onclick="submitResponse('future')">Submit Future Response</button>
        </div>
    </div>
    </div>

Â  <script>
    // Define initial responses at the center (1/3, 1/3, 1/3)
    const defaultA = 1/3;
    const defaultB = 1/3;
    const defaultC = 1 - defaultA - defaultB;
    
    // -------------------------
    // ðŸ”‘ ADMIN CONFIGURATION
    // -------------------------
    // Set to your specific admin email address (USED FOR DISPLAYING EXPORT BUTTON)
    const ADMIN_EMAIL = 'cian.mcadam@ucdconnect.ie'; 
    
    // -------------------------------------------------------------------------------------------------------
    // ðŸ”‘ SUPABASE SERVICE ROLE KEY (Used ONLY for Admin Export to bypass RLS)
    // -------------------------------------------------------------------------------------------------------
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTQ0MTIxOCwiZXhwIjoyMDc1MDE3MjE4fQ.WT_z-BJRTfu9EqO1Fig515aYF9FUOQGOQQgJ86AjM3Q';
    
    // -------------------------
    // ðŸ”‘ SUPABASE PUBLIC (ANON) KEY (Used for user sign-in and submissions)
    // -------------------------
    const supabaseUrl = "https://ttqxpcstznjxkmznyxis.supabase.co";
Â  Â  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDEyMTgsImV4cCI6MjA3NTAxNzIxOH0.RD-TfpgcLWhBF6G8Y8AeEI9pZTsDKQu-r-fMzvYtgG4";

    let supabase = null; 
    let user = null;
    
    // Initial responses state
Â  Â  let responses = { 
        present: { a: defaultA, b: defaultB, c: defaultC }, 
        future: { a: defaultA, b: defaultB, c: defaultC } 
    };

    // ------------------------------------
Â  Â  // ðŸ”¹ PLOTLY FUNCTIONS (Handles plot creation and click events)
Â  Â  // ------------------------------------

Â  Â  function makePlot(divId, resultId, label) {
Â  Â  Â  const initialResponse = responses[label.toLowerCase()];
    
Â  Â  Â  var userDot = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: [initialResponse.a],
Â  Â  Â  Â  b: [initialResponse.b],
Â  Â  Â  Â  c: [initialResponse.c],
Â  Â  Â  Â  marker: { size: 14, color: '#ff3366', line: { width: 2, color: 'white' } },
Â  Â  Â  Â  name: "Your Choice"
Â  Â  Â  };

Â  Â  Â  // High-density grid for smooth clicking across the entire plot area
Â  Â  Â  let gridPoints = [];
Â  Â  Â  let step = 0.01; 
Â  Â  Â  for (let a = 0; a <= 1 + 1e-6; a += step) {
Â  Â  Â  Â  for (let b = 0; b <= 1 - a + 1e-6; b += step) {
Â  Â  Â  Â  Â  let c = 1 - a - b;
Â  Â  Â  Â  Â  if (c >= -1e-6) {
Â  Â  Â  Â  Â  Â  gridPoints.push({a, b, c});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  var clickableLayer = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: gridPoints.map(p => p.a),
Â  Â  Â  Â  b: gridPoints.map(p => p.b),
Â  Â  Â  Â  c: gridPoints.map(p => p.c),
Â  Â  Â  Â  marker: { size: 10, color: 'rgba(0,0,0,0)' }, // Invisible but clickable
Â  Â  Â  Â  text: gridPoints.map(p =>Â 
Â  Â  Â  Â  Â  `Corporate: ${(p.a*100).toFixed(0)}%, Human: ${(p.b*100).toFixed(0)}%, Environmental: ${(p.c*100).toFixed(0)}%`
Â  Â  Â  Â  ),
Â  Â  Â  Â  hoverinfo: "text",
Â  Â  Â  Â  name: "Clickable Area",
        showlegend: false
Â  Â  Â  };

Â  Â  Â  var data = [clickableLayer, userDot];

Â  Â  Â  var layout = {
Â  Â  Â  Â  ternary: {
Â  Â  Â  Â  Â  aaxis: { title: "Corporate Rights (A)", min: 0.0, ticksuffix: "%", tickformat: '.0%' },
Â  Â  Â  Â  Â  baxis: { title: "Human Rights (B)", min: 0.0, ticksuffix: "%", tickformat: '.0%' },
Â  Â  Â  Â  Â  caxis: { title: "Environmental Rights (C)", min: 0.0, ticksuffix: "%", tickformat: '.0%' },
          sum: 1
Â  Â  Â  Â  },
Â  Â  Â  Â  title: label,
Â  Â  Â  Â  clickmode: 'event+select',
        margin: { t: 50, r: 20, b: 50, l: 20 },
        responsive: true
Â  Â  Â  };

Â  Â  Â  Plotly.newPlot(divId, data, layout, { responsive: true });

Â  Â  Â  var plotDiv = document.getElementById(divId);
        const type = label.toLowerCase();
        
Â  Â  Â  // Show default choice
Â  Â  Â  document.getElementById(resultId).innerHTML =
Â  Â  Â  Â  `You chose â†’ Corporate: ${(initialResponse.a*100).toFixed(0)}%, Human: ${(initialResponse.b*100).toFixed(0)}%, Environmental: ${(initialResponse.c*100).toFixed(0)}%`;

Â  Â  Â  // Capture clicks: updates the dot position and displays the new values
Â  Â  Â  plotDiv.on('plotly_click', function(eventData) {
Â  Â  Â  Â  var pt = eventData.points[0];
Â  Â  Â  Â  var a = pt.a;
Â  Â  Â  Â  var b = pt.b;
Â  Â  Â  Â  var c = pt.c;

        // Re-normalize to ensure the sum is exactly 1.0, correcting for float errors
        const sum = a + b + c;
        if (sum > 0.999 && sum < 1.001) { 
             a = a / sum;
             b = b / sum;
             c = c / sum;
        } else {
            console.warn("Plotly click gave non-normalized values.");
            return; 
        }

Â  Â  Â  Â  responses[type] = { a, b, c };

Â  Â  Â  Â  // Update marker (Trace 1 - the user dot) position
Â  Â  Â  Â  Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]);

Â  Â  Â  Â  // Show choice
Â  Â  Â  Â  document.getElementById(resultId).innerHTML =
Â  Â  Â  Â  Â  `You chose â†’ Corporate: ${(a*100).toFixed(0)}%, Human: ${(b*100).toFixed(0)}%, Environmental: ${(c*100).toFixed(0)}%`;
Â  Â  Â  });
Â  Â  }

    // ------------------------------------
Â  Â  // ðŸ”¹ SUPABASE SETUP & AUTHENTICATION
Â  Â  // ------------------------------------

    window.onload = function() {
        if (window.supabase) {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log("Supabase Client initialized.");
            // Set up listener for login/logout events
            supabase.auth.onAuthStateChange(handleAuthStateChange);
        } else {
            console.error("Supabase library not loaded.");
        }

        // Initialize plots
        makePlot("plot-present", "result-present", "Present");
        makePlot("plot-future", "result-future", "Future");
    };
    
    // Get the base URL for the redirect
    const getCurrentCleanUrl = () => {
        const url = window.location.href;
        return url.split(/[?#]/)[0];
    };

Â  Â  // Function to handle user sign-in via magic link
Â  Â  async function signIn() {
        if (!supabase) { alert("Application is still loading."); return; }
Â  Â  Â  const email = prompt("Enter your email to receive a login link:");
Â  Â  Â  if (!email) return;
Â  Â  Â  
Â  Â  Â  const { error } = await supabase.auth.signInWithOtp({ 
        email, 
        options: { 
            emailRedirectTo: getCurrentCleanUrl()
        } 
      });
      
Â  Â  Â  if (error) {
Â  Â  Â  Â  alert("Login Error: " + error.message);
        console.error("Login attempt failed:", error);
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âœ… Success! Check your email for a magic login link to access the survey.");
Â  Â  Â  }
Â  Â  }

    // Helper to control visibility of the admin export button
    function toggleAdminElements(isAdmin) {
        const exportButton = document.getElementById('export-button');
        if (exportButton) {
            exportButton.style.display = isAdmin ? 'block' : 'none';
        }
    }

Â  Â  // Handler for when the user's login state changes
Â  Â  function handleAuthStateChange(event, session) {
Â  Â  Â  if (session && session.user) {
Â  Â  Â  Â  user = session.user;
        
        const adminEmailLower = ADMIN_EMAIL.toLowerCase().trim();
        const userEmailLower = user.email ? user.email.toLowerCase().trim() : '';

        // Check if the logged-in user is the admin
        const isAdmin = userEmailLower === adminEmailLower;

        let statusText = `âœ… Welcome! You are logged in as: ${user.email}`;
        if (isAdmin) {
            statusText += " (Admin)";
        }

Â  Â  Â  Â  document.getElementById("auth-status").innerText = statusText;
        toggleAdminElements(isAdmin); // Show/Hide based on admin status
        
Â  Â  Â  } else {
Â  Â  Â  Â  user = null;
Â  Â  Â  Â  document.getElementById("auth-status").innerText = "Not logged in";
        toggleAdminElements(false);
Â  Â  Â  }
Â  Â  };

    // ------------------------------------
Â  Â  // ðŸ”¹ SUBMISSION LOGIC
Â  Â  // ------------------------------------

Â  Â  async function submitResponse(type) {
        if (!supabase) { alert("Application is still loading."); return; }
Â  Â  Â  if (!user) { alert("Please log in first to submit your response."); return; }
        
      // Check for duplicate submission
      const { data: existingResponse, error: selectError } = await supabase
        .from('responses')
        .select('id')
        .eq('user_id', user.id)
        .eq('type', type);

      if (selectError) {
        console.error("Error checking existing response:", selectError);
        alert("Error checking submission status. See console for details.");
        return;
      }
      
      if (existingResponse && existingResponse.length > 0) {
        alert(`âš ï¸ You have already submitted your response for '${type}'. You are limited to one submission per plot.`);
        return;
      }
      
      // Insert new response
Â  Â  Â  const { error: insertError } = await supabase
Â  Â  Â  Â  .from("responses")
Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  a: responses[type].a, // Corporate Rights
Â  Â  Â  Â  Â  b: responses[type].b, // Human Rights
Â  Â  Â  Â  Â  c: responses[type].c  // Environmental Rights
Â  Â  Â  Â  }]);

Â  Â  Â  if (insertError) {
        console.error("Submission Error:", insertError);
Â  Â  Â  Â  alert("Error submitting response: " + insertError.message);
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âœ… Response successfully submitted! Thank you.");
Â  Â  Â  }
Â  Â  }

    // ------------------------------------
    // ðŸ”¹ ADMIN EXPORT FUNCTION
    // ------------------------------------
    async function exportToExcel() {
        // Explicit client-side check for admin
        if (!user || user.email.toLowerCase().trim() !== ADMIN_EMAIL.toLowerCase().trim()) {
            alert("ðŸ›‘ Access Denied: Only the administrator can export data.");
            return;
        }
        
        // Create a temporary client using the Service Role Key to bypass Row Level Security (RLS)
        const serviceSupabase = window.supabase.createClient(supabaseUrl, SUPABASE_SERVICE_KEY, {
            auth: {
                autoRefreshToken: false,
                persistSession: false,
                detectSessionInUrl: false
            }
        });
        
        // Fetch all data
        const { data, error } = await serviceSupabase
            .from('responses')
            .select('user_id, type, a, b, c, created_at'); 

        if (error) {
            console.error("Export Error (Check Service Key or database permissions):", error); 
            alert("Fatal Error fetching data. See console for debugging.");
            return;
        }

        if (!data || data.length === 0) {
            alert("No data available to export.");
            return;
        }

        // Prepare the CSV content
        const headers = ["User ID", "Type", "Corporate (A)", "Human (B)", "Environmental (C)", "Timestamp"];
        const csvRows = data.map(row => [
            `"${row.user_id}"`, 
            row.type,
            row.a.toFixed(4), 
            row.b.toFixed(4),
            row.c.toFixed(4),
            row.created_at
        ].join(','));

        const csvContent = headers.join(',') + '\n' + csvRows.join('\n');

        // Create a Blob and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const date = new Date().toISOString().slice(0, 10);
        link.download = `ternary_survey_data_${date}.csv`;
        link.href = URL.createObjectURL(blob);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert(`âœ… ${data.length} records exported successfully!`);
    }

    // Make the functions globally accessible
    window.signIn = signIn;
    window.submitResponse = submitResponse;
    window.exportToExcel = exportToExcel;
Â  </script>
</body>
</html>
