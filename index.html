<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <title>Ternary Plot Survey with Supabase Login</title>
Â  <!-- Load Plotly first -->
Â  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script> <!-- FIXED: Updated to specific version 2.32.0 -->
Â  <!-- Then load Supabase -->
Â  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
Â  <h1>Ternary Plot Survey</h1>
Â  <p>
Â  Â  Please indicate the relative importance of
Â  Â  <b>Corporate Rights</b>, <b>Human Rights</b>, and <b>Environmental Rights</b>.
Â  Â  You must log in before submitting.
Â  </p>

Â  <!-- Login -->
Â  <button onclick="signIn()">Login with Email</button>
Â  <p id="auth-status">Not logged in</p>

Â  <!-- Present Day Plot -->
Â  <h2>Present Day Values</h2>
Â  <div id="plot-present" style="width:600px;height:600px;"></div>
Â  <button onclick="submitResponse('present')">Submit Present Response</button>
Â  <p id="result-present"></p>

Â  <!-- Future Plot -->
Â  <h2>Values in 2075</h2>
Â  <div id="plot-future" style="width:600px;height:600px;"></div>
Â  <button onclick="submitResponse('future')">Submit Future Response</button>
Â  <p id="result-future"></p>

Â  <script>
    // Define initial responses at the center (1/3, 1/3, 1/3)
    const defaultA = 1/3;
    const defaultB = 1/3;
    const defaultC = 1 - defaultA - defaultB; // Ensure sum is 1
    
Â  Â  // -------------------------
Â  Â  // ğŸ”¹ PLOTLY FUNCTIONS
Â  Â  // -------------------------
    // Initialize responses with calculated defaults
Â  Â  let responses = { 
        present: { a: defaultA, b: defaultB, c: defaultC }, 
        future: { a: defaultA, b: defaultB, c: defaultC } 
    };

Â  Â  function makePlot(divId, resultId, label) {
Â  Â  Â  const initialResponse = responses[label.toLowerCase()];
    
Â  Â  Â  // Default blue dot using consistent calculated values
Â  Â  Â  var userDot = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: [initialResponse.a],
Â  Â  Â  Â  b: [initialResponse.b],
Â  Â  Â  Â  c: [initialResponse.c],
Â  Â  Â  Â  marker: { size: 14, color: 'blue' },
Â  Â  Â  Â  name: "Your Choice"
Â  Â  Â  };

Â  Â  Â  // Transparent clickable grid (high resolution)
Â  Â  Â  let gridPoints = [];
Â  Â  Â  let step = 0.02; // finer precision
Â  Â  Â  for (let a = 0; a <= 1 + 1e-6; a += step) { // +1e-6 for float precision
Â  Â  Â  Â  for (let b = 0; b <= 1 - a + 1e-6; b += step) {
Â  Â  Â  Â  Â  let c = 1 - a - b;
Â  Â  Â  Â  Â  if (c >= -1e-6) { // allow slight negative due to float errors
Â  Â  Â  Â  Â  Â  gridPoints.push({a, b, c});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  var clickableLayer = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: gridPoints.map(p => p.a),
Â  Â  Â  Â  b: gridPoints.map(p => p.b),
Â  Â  Â  Â  c: gridPoints.map(p => p.c),
Â  Â  Â  Â  marker: { size: 15, color: 'rgba(0,0,0,0)' }, // invisible clickable points
Â  Â  Â  Â  text: gridPoints.map(p =>Â 
Â  Â  Â  Â  Â  `Corporate: ${p.a.toFixed(2)}, Human: ${p.b.toFixed(2)}, Environmental: ${p.c.toFixed(2)}`
Â  Â  Â  Â  ),
Â  Â  Â  Â  hoverinfo: "text",
Â  Â  Â  Â  name: "Clickable Area"
Â  Â  Â  };

Â  Â  Â  // Place userDot (trace index 1) on top of clickableLayer (trace index 0)
Â  Â  Â  var data = [clickableLayer, userDot];

Â  Â  Â  var layout = {
Â  Â  Â  Â  ternary: {
Â  Â  Â  Â  Â  aaxis: { title: "Corporate Rights", min: 0.01 },
Â  Â  Â  Â  Â  baxis: { title: "Human Rights", min: 0.01 },
Â  Â  Â  Â  Â  caxis: { title: "Environmental Rights", min: 0.01 }
Â  Â  Â  Â  },
Â  Â  Â  Â  title: label,
Â  Â  Â  Â  clickmode: 'event+select'
Â  Â  Â  };

Â  Â  Â  Plotly.newPlot(divId, data, layout);

Â  Â  Â  var plotDiv = document.getElementById(divId);
        const type = label.toLowerCase();
        
Â  Â  Â  // Show default choice
Â  Â  Â  document.getElementById(resultId).innerHTML =
Â  Â  Â  Â  `You chose â†’ Corporate: ${initialResponse.a.toFixed(2)}, Human: ${initialResponse.b.toFixed(2)}, Environmental: ${initialResponse.c.toFixed(2)}`;

Â  Â  Â  // Capture clicks
Â  Â  Â  plotDiv.on('plotly_click', function(eventData) {
Â  Â  Â  Â  var pt = eventData.points[0];
Â  Â  Â  Â  var a = pt.a;
Â  Â  Â  Â  var b = pt.b;
Â  Â  Â  Â  var c = pt.c;

        // Ensure values sum to 1 and are non-negative, and correct float errors
        const sum = a + b + c;
        if (sum > 0.99 && sum < 1.01) { // Check if close to 1
             a = a / sum;
             b = b / sum;
             c = c / sum;
        } else {
            // Plotly's click event should provide valid ternary points, but just in case
            console.warn("Plotly click gave non-normalized values.");
            return; 
        }

Â  Â  Â  Â  responses[type] = { a, b, c };

Â  Â  Â  Â  // Update marker (Trace 1)
Â  Â  Â  Â  Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]);

Â  Â  Â  Â  // Show choice
Â  Â  Â  Â  document.getElementById(resultId).innerHTML =
Â  Â  Â  Â  Â  `You chose â†’ Corporate: ${a.toFixed(2)}, Human: ${b.toFixed(2)}, Environmental: ${c.toFixed(2)}`;
Â  Â  Â  });
Â  Â  }

Â  Â  // Build both plots immediately
Â  Â  makePlot("plot-present", "result-present", "Present");
Â  Â  makePlot("plot-future", "result-future", "Future");

Â  Â  // -------------------------
Â  Â  // ğŸ”¹ SUPABASE SETUP
Â  Â  // -------------------------
Â  Â  const supabaseUrl = "https://ttqxpcstznjxkmznyxis.supabase.co";
Â  Â  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDEyMTgsImV4cCI6MjA3NTAxNzIxOH0.RD-TfpgcLWhBF6G8Y8AeEI9pZTsDKQu-r-fMzvYtgG4";
Â  Â  
    // FIX: Correctly initialize the client using window.supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

Â  Â  let user = null;

Â  Â  // Login with magic link
Â  Â  async function signIn() {
Â  Â  Â  const email = prompt("Enter your email to receive a login link:");
Â  Â  Â  if (!email) return;
Â  Â  Â  
      // FIX: Added emailRedirectTo option for better magic link flow
Â  Â  Â  const { error } = await supabase.auth.signInWithOtp({ 
        email, 
        options: { 
            emailRedirectTo: window.location.origin 
        } 
      });
      
Â  Â  Â  if (error) {
Â  Â  Â  Â  alert("Login Error: " + error.message);
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âœ… Success! Check your email for a magic login link. After clicking it, youâ€™ll return here and be logged in automatically.");
Â  Â  Â  }
Â  Â  }

Â  Â  // Auth state change
Â  Â  supabase.auth.onAuthStateChange((event, session) => {
Â  Â  Â  if (session && session.user) {
Â  Â  Â  Â  user = session.user;
Â  Â  Â  Â  document.getElementById("auth-status").innerText =
Â  Â  Â  Â  Â  "âœ… Welcome! You are logged in as: " + user.email;
Â  Â  Â  } else {
Â  Â  Â  Â  user = null;
Â  Â  Â  Â  document.getElementById("auth-status").innerText = "Not logged in";
Â  Â  Â  }
Â  Â  });

Â  Â  // Submit response
Â  Â  async function submitResponse(type) {
Â  Â  Â  if (!responses[type]) {
Â  Â  Â  Â  alert("Please click inside the plot before submitting.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!user) {
Â  Â  Â  Â  alert("Please log in first.");
Â  Â  Â  Â  return;
Â  Â  Â  }
        
      // ğŸš¨ NEW: Check if a response of this 'type' (present or future) already exists for this user.
      const { data: existingResponse, error: selectError } = await supabase
        .from('responses')
        .select('id')
        .eq('user_id', user.id)
        .eq('type', type);

      if (selectError) {
        console.error("Error checking existing response:", selectError);
        alert("Error checking submission status. See console for details.");
        return;
      }
      
      // If the query returned one or more rows, the user has already submitted.
      if (existingResponse && existingResponse.length > 0) {
        alert(`âš ï¸ You have already submitted your response for '${type}'. You are limited to one submission per plot.`);
        return;
      }
      
      // If the user has not submitted yet, proceed with insertion.
Â  Â  Â  const { error: insertError } = await supabase
Â  Â  Â  Â  .from("responses")
Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  a: responses[type].a,
Â  Â  Â  Â  Â  b: responses[type].b,
Â  Â  Â  Â  Â  c: responses[type].c
Â  Â  Â  Â  }]);

Â  Â  Â  if (insertError) {
        console.error("Submission Error:", insertError);
Â  Â  Â  Â  alert("Error submitting response: " + insertError.message);
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âœ… Response successfully submitted!");
Â  Â  Â  }
Â  Â  }
Â  </script>
</body>
</html>
