<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ternary Plot Survey with Supabase Login</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <style>
    #plot-present, #plot-future {
      width: 100%;
      min-height: 400px;
    }
    /* Center toast message styling */
    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 14px 24px;
      border-radius: 10px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: none;
    }
    #toast.show {
      display: block;
      animation: fadeInOut 4s ease-in-out;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -20px); }
      10%, 90% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen p-6 font-sans">
  <!-- Toast Message -->
  <div id="toast" class="bg-green-600 text-white text-center text-base sm:text-lg"></div>

  <div class="max-w-6xl mx-auto">
    <header class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h1 class="text-3xl font-extrabold text-blue-800 border-b-2 border-blue-200 pb-3 mb-3">
        Ternary Plot Survey
      </h1>
      <p class="text-gray-600 mb-4">
        Please indicate how you think society currently balances
        <b>Corporate Rights</b>, <b>Human Rights</b>, and <b>Environmental Rights</b>,
        and how you think it will balance them in 2075.
        You must log in before submitting.
      </p>

      <!-- Login -->
      <button onclick="signIn()"
        class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
        Login with Magic Link
      </button>
      <p id="auth-status" class="mt-3 text-gray-700 font-semibold">Not logged in</p>

      <!-- Admin Banner -->
      <div id="admin-banner" class="hidden mt-4 p-3 rounded-lg border border-green-400 bg-green-100 text-green-800 font-bold">
        âœ… Admin Mode Active â€” You can export all responses.
      </div>

      <!-- Export Button (Admin only) -->
      <button id="export-button" onclick="exportToExcel()" class="hidden mt-4 px-5 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
        Export All Responses to CSV (Excel)
      </button>
    </header>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Present Plot -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-blue-800 border-b border-gray-200 pb-2 mb-4">
          Present Day Values
        </h2>
        <div id="plot-present"></div>
        <button onclick="submitResponse('present')"
          class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
          Submit Present Response
        </button>
        <p id="result-present" class="mt-3 text-gray-600 text-center"></p>
      </div>

      <!-- Future Plot -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-blue-800 border-b border-gray-200 pb-2 mb-4">
          Values in 2075
        </h2>
        <div id="plot-future"></div>
        <button onclick="submitResponse('future')"
          class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
          Submit Future Response
        </button>
        <p id="result-future" class="mt-3 text-gray-600 text-center"></p>
      </div>
    </div>
  </div>

  <script>
    // ðŸŸ¢ Admin email
    const ADMIN_EMAIL = "cian.mcadam@ucdconnect.ie";

    // ðŸŸ¢ Supabase configuration
    const supabaseUrl = "https://szcqmwsnzqdciqablixv.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Y3Ftd3NuenFkY2lxYWJsaXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzg2OTMsImV4cCI6MjA3NDc1NDY5M30.LE3Qh79LqZacPRrcyvCJOZcJ9FLyADoK5r6dumoNZR0";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let responses = {
      present: { a: 1/3, b: 1/3, c: 1/3 },
      future: { a: 1/3, b: 1/3, c: 1/3 }
    };
    let user = null;

    // ðŸ”” Toast Function
    function showToast(message, color = "bg-green-600") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = `show text-white text-center rounded-lg px-6 py-3 ${color}`;
      setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }

    // ðŸ“Š Plot Creation
    function makePlot(divId, resultId, label) {
      const initial = responses[label.toLowerCase()];
      const userDot = {
        type: "scatterternary",
        mode: "markers",
        a: [initial.a],
        b: [initial.b],
        c: [initial.c],
        marker: { size: 14, color: "blue" },
        name: "Your Choice",
      };

      const grid = [];
      for (let a = 0; a <= 1; a += 0.02) {
        for (let b = 0; b <= 1 - a; b += 0.02) {
          grid.push({ a, b, c: 1 - a - b });
        }
      }

      const clickLayer = {
        type: "scatterternary",
        mode: "markers",
        a: grid.map((p) => p.a),
        b: grid.map((p) => p.b),
        c: grid.map((p) => p.c),
        marker: { size: 18, color: "rgba(0,0,0,0)" },
        hoverinfo: "none",
      };

      Plotly.newPlot(divId, [clickLayer, userDot], {
        ternary: {
          aaxis: { title: "Corporate Rights" },
          baxis: { title: "Human Rights" },
          caxis: { title: "Environmental Rights" },
        },
        title: label,
      });

      const plotDiv = document.getElementById(divId);
      const type = label.toLowerCase();

      plotDiv.on("plotly_click", (e) => {
        const { a, b, c } = e.points[0];
        responses[type] = { a, b, c };
        Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]);
        document.getElementById(resultId).innerText =
          `You chose â†’ Corporate: ${a.toFixed(2)}, Human: ${b.toFixed(2)}, Environmental: ${c.toFixed(2)}`;
      });
    }

    window.onload = () => {
      makePlot("plot-present", "result-present", "Present");
      makePlot("plot-future", "result-future", "Future");
    };

    // ðŸ”‘ Login with Magic Link
    async function signIn() {
      const email = prompt("Enter your email to receive a login link:");
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href.split(/[?#]/)[0] },
      });
      if (error) alert("Login Error: " + error.message);
      else alert("âœ… Check your email for a magic link and click it to log in.");
    }

    // ðŸ‘¤ Auth Listener (includes toast)
    supabase.auth.onAuthStateChange((event, session) => {
      const status = document.getElementById("auth-status");
      const isAdmin = session?.user?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();

      if (session) {
        user = session.user;
        status.innerText = `âœ… Logged in as: ${user.email}`;
        document.getElementById("export-button").style.display = isAdmin ? "block" : "none";
        document.getElementById("admin-banner").style.display = isAdmin ? "block" : "none";
        showToast(`You're now logged in as ${user.email}!`, "bg-green-600");
      } else {
        user = null;
        status.innerText = "Not logged in";
        document.getElementById("export-button").style.display = "none";
        document.getElementById("admin-banner").style.display = "none";
      }
    });

    // ðŸ“¤ Submit Response
    async function submitResponse(type) {
      if (!user) return alert("Please log in first.");
      const { error } = await supabase.from("responses").insert([{
        user_id: user.id,
        type,
        a: responses[type].a,
        b: responses[type].b,
        c: responses[type].c,
      }]);
      if (error) alert("Error submitting: " + error.message);
      else showToast("âœ… Response saved successfully!");
    }

    // ðŸ“¥ Export (Admin Only)
    async function exportToExcel() {
      if (!user || user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase())
        return alert("ðŸ›‘ Only admin can export data.");

      const { data, error } = await supabase.from("responses").select("*");
      if (error) return alert("Error fetching data: " + error.message);
      if (!data.length) return alert("No responses found.");

      const csv = [
        ["user_id", "type", "a", "b", "c", "created_at"],
        ...data.map((r) => [r.user_id, r.type, r.a, r.b, r.c, r.created_at]),
      ].map((row) => row.join(",")).join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "responses_export.csv";
      link.click();

      showToast(`âœ… ${data.length} records exported successfully!`);
    }
  </script>
</body>
</html>
