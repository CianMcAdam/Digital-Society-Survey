<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ternary Plot Survey with Supabase Login</title>
  <!-- Load Plotly first -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Then load Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Ternary Plot Survey</h1>
  <p>
    Please indicate the relative importance of
    <b>Corporate Rights</b>, <b>Human Rights</b>, and <b>Environmental Rights</b>.
    You must log in before submitting.
  </p>

  <!-- Login -->
  <button onclick="signIn()">Login with Email</button>
  <p id="auth-status">Not logged in</p>

  <!-- Present Day Plot -->
  <h2>Present Day Values</h2>
  <div id="plot-present" style="width:600px;height:600px;"></div>
  <button id="submit-present" onclick="submitResponse('present')">Submit Present Response</button>
  <p id="result-present"></p>

  <!-- Future Plot -->
  <h2>Values in 2075</h2>
  <div id="plot-future" style="width:600px;height:600px;"></div>
  <button id="submit-future" onclick="submitResponse('future')">Submit Future Response</button>
  <p id="result-future"></p>

  <!-- Admin-only CSV Export -->
  <h2>Admin Controls</h2>
  <button id="export-btn" onclick="exportCSV()" style="display:none;">
    Export All Responses to CSV (Excel)
  </button>
  <p id="export-status"></p>

  <script>
    // -------------------------
    // 🔹 PLOTLY FUNCTIONS
    // -------------------------
    let responses = { present: null, future: null };

    function makePlot(divId, resultId, label) {
      var userDot = {
        type: 'scatterternary',
        mode: 'markers',
        a: [0.33],
        b: [0.33],
        c: [0.34],
        marker: { size: 14, color: 'blue' },
        name: "Your Choice"
      };

      responses[label.toLowerCase()] = { a: 0.33, b: 0.33, c: 0.34 };

      let gridPoints = [];
      let step = 0.02;
      for (let a = 0; a <= 1; a += step) {
        for (let b = 0; b <= 1 - a; b += step) {
          let c = 1 - a - b;
          if (c >= 0) gridPoints.push({a, b, c});
        }
      }

      var clickableLayer = {
        type: 'scatterternary',
        mode: 'markers',
        a: gridPoints.map(p => p.a),
        b: gridPoints.map(p => p.b),
        c: gridPoints.map(p => p.c),
        marker: { size: 15, color: 'rgba(0,0,0,0)' },
        text: gridPoints.map(p =>
          `Corporate: ${p.a.toFixed(2)}, Human: ${p.b.toFixed(2)}, Environmental: ${p.c.toFixed(2)}`
        ),
        hoverinfo: "text",
        name: "Clickable Area"
      };

      var data = [clickableLayer, userDot];

      var layout = {
        ternary: {
          aaxis: { title: "Corporate Rights", min: 0.01 },
          baxis: { title: "Human Rights", min: 0.01 },
          caxis: { title: "Environmental Rights", min: 0.01 }
        },
        title: label,
        clickmode: 'event+select'
      };

      Plotly.newPlot(divId, data, layout);

      var plotDiv = document.getElementById(divId);

      document.getElementById(resultId).innerHTML =
        `You chose → Corporate: 0.33, Human: 0.33, Environmental: 0.34`;

      plotDiv.on('plotly_click', function(eventData) {
        var pt = eventData.points[0];
        var a = pt.a;
        var b = pt.b;
        var c = pt.c;

        responses[label.toLowerCase()] = { a, b, c };

        Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]);

        document.getElementById(resultId).innerHTML =
          `You chose → Corporate: ${a.toFixed(2)}, Human: ${b.toFixed(2)}, Environmental: ${c.toFixed(2)}`;
      });
    }

    makePlot("plot-present", "result-present", "Present");
    makePlot("plot-future", "result-future", "Future");

    // -------------------------
    // 🔹 SUPABASE SETUP
    // -------------------------
    const supabaseUrl = "https://ttqxpcstznjxkmznyxis.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDEyMTgsImV4cCI6MjA3NTAxNzIxOH0.RD-TfpgcLWhBF6G8Y8AeEI9pZTsDKQu-r-fMzvYtgG4";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let user = null;

    async function signIn() {
      const email = prompt("Enter your email to receive a login link:");
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) {
        alert("Error: " + error.message);
      } else {
        alert("✅ Check your email for a magic login link. After clicking it, you’ll return here and be logged in automatically.");
      }
    }

    // Auth state change handler
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session && session.user) {
        user = session.user;
        document.getElementById("auth-status").innerText =
          "✅ Welcome! You are logged in as: " + user.email;

        if (user.email === "cian.mcadam@ucdconnect.ie") {
          document.getElementById("export-btn").style.display = "block";
        }

        // Check if this user already submitted responses
        await checkUserSubmissions();
      } else {
        user = null;
        document.getElementById("auth-status").innerText = "Not logged in";
        document.getElementById("export-btn").style.display = "none";
      }
    });

    // -------------------------
    // 🔹 CHECK PREVIOUS SUBMISSIONS
    // -------------------------
    async function checkUserSubmissions() {
      const { data, error } = await supabase
        .from("responses")
        .select("type")
        .eq("user_id", user.id);

      if (error) {
        console.error("Error checking submissions:", error.message);
        return;
      }

      const submittedTypes = data.map(row => row.type);

      if (submittedTypes.includes("present")) {
        document.getElementById("submit-present").disabled = true;
        document.getElementById("result-present").innerText = "✅ You’ve already submitted your Present response.";
      }

      if (submittedTypes.includes("future")) {
        document.getElementById("submit-future").disabled = true;
        document.getElementById("result-future").innerText = "✅ You’ve already submitted your Future response.";
      }
    }

    // -------------------------
    // 🔹 SUBMIT RESPONSE FUNCTION
    // -------------------------
    async function submitResponse(type) {
      if (!responses[type]) {
        alert("Please click inside the plot before submitting.");
        return;
      }
      if (!user) {
        alert("Please log in first.");
        return;
      }

      // Check for existing submission
      const { data: existing, error: checkError } = await supabase
        .from("responses")
        .select("*")
        .eq("user_id", user.id)
        .eq("type", type);

      if (checkError) {
        alert("Error checking existing submissions: " + checkError.message);
        return;
      }

      if (existing.length > 0) {
        alert("⚠️ You’ve already submitted for this plot!");
        return;
      }

      // Insert new response
      const { error } = await supabase
        .from("responses")
        .insert([{
          user_id: user.id,
          type: type,
          a: responses[type].a,
          b: responses[type].b,
          c: responses[type].c
        }]);

      if (error) {
        alert("Error: " + error.message);
      } else {
        alert("✅ Response submitted!");
        await checkUserSubmissions(); // Refresh UI
      }
    }

    // -------------------------
    // 🔹 ADMIN EXPORT FEATURE
    // -------------------------
    async function exportCSV() {
      const { data, error } = await supabase
        .from('responses')
        .select('*');

      if (error) {
        alert('Error fetching data: ' + error.message);
        return;
      }

      const csv = [
        ['user_id', 'type', 'a', 'b', 'c', 'created_at'],
        ...data.map(r => [r.user_id, r.type, r.a, r.b, r.c, r.created_at])
      ].map(e => e.join(",")).join("\n");

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'responses_export.csv';
      link.click();
      document.getElementById('export-status').innerText = '✅ CSV exported successfully.';
    }
  </script>
</body>
</html>
