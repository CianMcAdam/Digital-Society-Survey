<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ternary Plot Survey V2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <style>
    /* Styling for plot containers for responsiveness */
    #plot-present, #plot-future {
      width: 100%;
      min-height: 400px;
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            'primary-blue': '#1e40af',
            'primary-hover': '#1d3f9b',
            'success-green': '#059669',
            'warning-yellow': '#f59e0b',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">
  <!-- Global Message Box -->
  <div id="message-box" class="fixed top-4 right-6 z-[100] max-w-sm sm:max-w-md lg:max-w-lg"></div>

  <div class="max-w-6xl mx-auto">
    <header class="mb-8 p-6 bg-white rounded-xl shadow-lg">
      <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-indigo-200 pb-3 mb-2">
        Ternary Plot Survey V2
      </h1>
      <p class="text-gray-600 mb-4">
        Please place a point to indicate how you think society
        <b class="text-indigo-700">currently balances</b> Corporate, Human, and Environmental Rights — and how it might balance them in <b>2075</b>.
      </p>

      <div class="flex flex-col sm:flex-row sm:items-center justify-between space-y-3 sm:space-y-0">
        <button onclick="signIn()" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
          Login with Magic Link
        </button>
        <p id="auth-status" class="px-4 py-2 text-sm font-semibold rounded-lg shadow-inner bg-gray-200 text-gray-700">
          Not logged in
        </p>
      </div>

      <!-- Admin Controls -->
      <div id="admin-banner" class="hidden mt-4 p-3 rounded-lg border border-green-400 bg-green-100 text-green-800 font-bold">
        ✅ Admin Mode Active
      </div>

      <button id="export-button" onclick="exportToExcel()" class="hidden mt-4 px-5 py-2 bg-success-green text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-lg">
        Export All Responses to CSV (Excel)
      </button>
    </header>

    <div class="grid lg:grid-cols-2 gap-8 mt-8">
      <div class="bg-white p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-semibold text-primary-blue border-b border-indigo-200 pb-3 mb-4">Present Day Values</h2>
        <div id="plot-present" class="w-full h-[450px] md:h-[550px]"></div>
        <button id="submit-present" onclick="submitResponse('present')" class="w-full mt-6 px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-primary-hover transition duration-150 shadow-md">
          Submit Present Response
        </button>
        <p id="result-present" class="mt-3 text-sm text-gray-600 text-center"></p>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-semibold text-primary-blue border-b border-indigo-200 pb-3 mb-4">Values in 2075</h2>
        <div id="plot-future" class="w-full h-[450px] md:h-[550px]"></div>
        <button id="submit-future" onclick="submitResponse('future')" class="w-full mt-6 px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-primary-hover transition duration-150 shadow-md">
          Submit Future Response
        </button>
        <p id="result-future" class="mt-3 text-sm text-gray-600 text-center"></p>
      </div>
    </div>
  </div>

  <script>
    // === Supabase Configuration ===
    const RESPONSES_TABLE = "responses_v2";
    const ADMIN_EMAIL = "cian.mcadam@ucdconnect.ie";
    
    // Project URL must match the reference embedded in the keys below (szcqmwsnzqdciqablixv)
    const SUPABASE_URL = "https://szcqmwsnzqdciqablixv.supabase.co";
    
    // Fresh 'anon public' key
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Y3Ftd3NuenFkY2lxYWJsaXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzg2OTMsImV4cCI6MjA3NDc1NDY5M30.LE3Qh79LqZacPRrcyvCJOZcJ9FLyADoK5r6dumoNZR0";
    
    // Fresh 'service_role' key (USED ONLY FOR ADMIN EXPORT)
    const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Y3Ftd3NuenFkY2lxYWJsaXh2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTE3ODY5MywiZXhwIjoyMDc0NzU0NjkzfQ.rAay6ltzd5bfODomD5MtOGaa_7XYJRohffkBhUg6gys";

    // Client for all user-facing operations (relies on RLS)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let user = null;
    let responses = { present: { a: 1/3, b: 1/3, c: 1/3 }, future: { a: 1/3, b: 1/3, c: 1/3 } };

    // --- Utility for showing messages ---
    function showMessage(text, type = 'info') {
      const box = document.createElement('div');
      const colors = {
        success: ['bg-success-green', '✅'],
        error: ['bg-red-600', '❌'],
        warning: ['bg-warning-yellow', '⚠️'],
        info: ['bg-indigo-500', 'ℹ️']
      };
      const [bgColor, icon] = colors[type] || colors.info;
      box.className = `p-4 mb-2 rounded-lg shadow-xl font-semibold ${bgColor} text-white opacity-0 transition-all duration-500 transform translate-x-full`;
      box.innerHTML = `<div class="flex items-start space-x-2">${icon}<span>${text}</span></div>`;
      const container = document.getElementById('message-box');
      container.appendChild(box);
      setTimeout(() => { box.style.opacity = 1; box.style.transform = 'translateX(0)'; }, 10);
      setTimeout(() => { box.style.opacity = 0; box.style.transform = 'translateY(100px)'; setTimeout(() => box.remove(), 500); }, 5000);
    }

    // --- Plotting logic ---
    function makePlot(divId, resultId, label) {
      const type = label.toLowerCase();
      const initial = responses[type];
      const userDot = { type: 'scatterternary', mode: 'markers', a: [initial.a], b: [initial.b], c: [initial.c], marker: { size: 16, color: 'blue' } };
      
      const grid = [];
      for (let a = 0; a <= 1; a += 0.02)
        for (let b = 0; b <= 1 - a; b += 0.02)
          grid.push({ a, b, c: 1 - a - b });
      const clickLayer = { type: 'scatterternary', mode: 'markers', a: grid.map(p => p.a), b: grid.map(p => p.b), c: grid.map(p => p.c), marker: { size: 18, color: 'rgba(0,0,0,0)' }, hoverinfo: 'none' };
      
      Plotly.newPlot(divId, [clickLayer, userDot], {
        ternary: { 
            aaxis: { title: "Corporate Rights", tickangle: 0 }, 
            baxis: { title: "Human Rights", tickangle: 60 }, 
            caxis: { title: "Environmental Rights", tickangle: -60 } 
        },
        title: label, autosize: true
      });

      document.getElementById(divId).on('plotly_click', e => {
        const { a, b, c } = e.points[0];
        responses[type] = { a, b, c };
        Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]); 
        document.getElementById(resultId).innerText = `You chose → Corporate: ${a.toFixed(2)}, Human: ${b.toFixed(2)}, Environmental: ${c.toFixed(2)}`;
      });
    }

    window.onload = () => {
      makePlot("plot-present", "result-present", "Present");
      makePlot("plot-future", "result-future", "Future");
      // Check auth state immediately to fetch data if user is already logged in
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            // Manually call the handler to process the existing session
            handleAuthStateChange(session.user);
        }
      });
    };

    // --- Authentication ---
    async function signIn() {
      const email = prompt("Enter your email to receive a login link:");
      if (!email) return;
      // Note: emailRedirectTo helps ensure the session token is handled correctly on return
      const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href.split(/[?#]/)[0] } });
      if (error) showMessage("Login Error: " + error.message, "error");
      else showMessage("✅ Check your email for a magic link. You may need to refresh after clicking the link.", "success");
    }
    
    // --- Helper to update UI after login/logout
    function handleAuthStateChange(sessionUser) {
        const authStatus = document.getElementById("auth-status");
        const exportButton = document.getElementById("export-button");
        const adminBanner = document.getElementById("admin-banner");
        
        if (sessionUser) {
            user = sessionUser;
            const isAdmin = user.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            authStatus.innerText = `✅ Logged in as: ${user.email} ${isAdmin ? "(Admin)" : ""}`;
            authStatus.className = `px-4 py-2 text-sm font-semibold rounded-lg shadow-inner ${isAdmin ? 'bg-green-200 text-green-800' : 'bg-warning-yellow text-gray-900'}`;
            exportButton.classList.toggle("hidden", !isAdmin);
            adminBanner.classList.toggle("hidden", !isAdmin);
            
            // Only fetch user data if logged in
            fetchUserResponses();
        } else {
            user = null;
            authStatus.innerText = "Not logged in";
            authStatus.className = "px-4 py-2 text-sm font-semibold rounded-lg shadow-inner bg-gray-200 text-gray-700";
            exportButton.classList.add("hidden");
            adminBanner.classList.add("hidden");
        }
    }

    // Listener for auth state changes (e.g., after magic link click)
    supabase.auth.onAuthStateChange((event, session) => {
        if (session?.user) {
            handleAuthStateChange(session.user);
        } else if (event === 'SIGNED_OUT') {
            handleAuthStateChange(null);
        }
    });
    
    // --- Fetch and display existing responses (if any) ---
    async function fetchUserResponses() {
      if (!user) return;
      
      // Reset button states before fetching
      ['present', 'future'].forEach(type => {
          const button = document.getElementById(`submit-${type}`);
          button.disabled = false;
          button.textContent = `Submit ${type === 'present' ? 'Present' : 'Future'} Response`;
          button.classList.add('bg-primary-blue', 'hover:bg-primary-hover');
          button.classList.remove('bg-gray-400', 'cursor-not-allowed');
      });

      try {
        // This SELECT is allowed by the RLS Policy #2 (Users can select their own responses)
        const { data, error } = await supabase
          .from(RESPONSES_TABLE)
          .select("type, a, b, c")
          .eq("user_id", user.id);
          
        if (error) {
          showMessage(`Error fetching past responses. Error: ${error.message}`, "error");
          console.error(`Error during fetchUserResponses: ${error.message}`);
          return;
        }
        
        if (data && data.length > 0) {
          data.forEach(response => {
            const type = response.type.toLowerCase();
            if (responses.hasOwnProperty(type)) {
              responses[type] = { a: response.a, b: response.b, c: response.c };
              
              const plotDivId = `plot-${type}`;
              const resultId = `result-${type}`;
              const buttonId = `submit-${type}`;

              // 1. Update Plot
              Plotly.restyle(plotDivId, { a: [[response.a]], b: [[response.b]], c: [[response.c]] }, [1]);
              
              // 2. Update Result Text
              document.getElementById(resultId).innerText = `You submitted → Corporate: ${response.a.toFixed(2)}, Human: ${response.b.toFixed(2)}, Environmental: ${response.c.toFixed(2)}`;
              
              // 3. Disable Button
              const button = document.getElementById(buttonId);
              if (button) {
                button.disabled = true;
                button.textContent = `Submitted (${type === 'present' ? 'Present' : 'Future'})`;
                button.classList.remove('bg-primary-blue', 'hover:bg-primary-hover');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
              }
            }
          });
        }
      } catch (e) {
        console.error("Uncaught error during fetchUserResponses:", e.message);
        showMessage("An unexpected error occurred during data load.", "error");
      }
    }


    // --- Submit response (Relies on DB unique constraint to prevent duplicates) ---
    async function submitResponse(type) {
      if (!user) return showMessage("Please log in first.", "warning");

      const button = document.getElementById(`submit-${type}`);
      if (button && button.disabled) {
        return showMessage("⚠️ You already submitted for this plot.", "warning");
      }

      const { error: insertError } = await supabase.from(RESPONSES_TABLE).insert([{
        user_id: user.id,
        type,
        a: responses[type].a,
        b: responses[type].b,
        c: responses[type].c
      }]);

      if (insertError) {
        if (insertError.code === '23505') { // PostgreSQL unique violation code
            showMessage("⚠️ Submission failed: You have already submitted for this plot type.", "warning");
        } else {
            // This catches RLS errors if the user_id somehow doesn't match the auth.uid()
            showMessage("Error submitting: " + insertError.message, "error");
        }
      } else {
        showMessage("✅ Response saved successfully! Reloading status.", "success");
      }
      
      // Update button state based on the outcome of the insert.
      fetchUserResponses();
    }

    // --- Admin export (Uses serviceSupabase to bypass RLS) ---
    async function exportToExcel() {
      if (!user || user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase())
        return showMessage("🛑 Only admin can export data.", "error");
      
      showMessage("Fetching all responses...", "info");

      // Temporarily create a service client inside the function to ensure the correct key is used.
      const serviceSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
        auth: { persistSession: false },
      });

      // Use the service client to bypass RLS
      const { data, error } = await serviceSupabaseClient
        .from(RESPONSES_TABLE)
        .select("user_id, type, a, b, c, created_at")
        .order('created_at', { ascending: true });

      if (error) {
        // This often happens if the service key is wrong or the table doesn't exist.
        return showMessage("Error fetching data for admin export: " + error.message, "error");
      }
      if (!data || !data.length) {
        return showMessage("No responses found to export.", "info");
      }

      // Create CSV content
      const headers = ["user_id", "type", "a", "b", "c", "created_at"];
      
      const csvData = data.map(r => [
        `"${r.user_id}"`, 
        r.type, 
        r.a, 
        r.b, 
        r.c,
        r.created_at
      ].join(",")).join("\n");
      
      const csv = [headers.join(","), csvData].join("\n");

      // Download logic
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = RESPONSES_TABLE + "_export.csv";
      link.click();

      showMessage(`✅ ${data.length} records exported successfully!`, "success");
    }

    window.signIn = signIn;
    window.submitResponse = submitResponse;
    window.exportToExcel = exportToExcel;
  </script>
</body>
</html>
