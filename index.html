<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Ternary Plot Survey with Supabase Login</title>
Â  <!-- Load Tailwind CSS -->
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <!-- Load Plotly first -->
Â  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
Â  <!-- Load Supabase -->
Â  <script src="https://unpkg.com/@supabase/supabase-js"></script>
Â  <style>
Â  Â  /* Custom styles for Plotly container sizing */
Â  Â  #plot-present, #plot-future {
Â  Â  Â  width: 100%;
Â  Â  Â  min-height: 400px;
Â  Â  }
Â  </style>
Â  <script>
Â  Â  tailwind.config = {
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  sans: ['Inter', 'sans-serif'],
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  'primary-blue': '#1e40af',
Â  Â  Â  Â  Â  Â  'primary-hover': '#1d3f9b',
Â  Â  Â  Â  Â  Â  'success-green': '#059669',
Â  Â  Â  Â  Â  Â  'warning-yellow': '#f59e0b',
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  </script>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">

Â  <!-- Global Message Box - Position adjusted to right-6 and max width increased -->
Â  <div id="message-box" class="fixed top-4 right-6 z-[100] max-w-sm sm:max-w-md lg:max-w-lg">
Â  Â  <!-- Messages will be injected here -->
Â  </div>

Â  <div class="max-w-6xl mx-auto">
Â  Â  <header class="mb-8 p-6 bg-white rounded-xl shadow-lg">
Â  Â  Â  Â  <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-indigo-200 pb-3 mb-2">
Â  Â  Â  Â  Â  Â  Ternary Plot Survey
Â  Â  Â  Â  </h1>
Â  Â  Â  Â  <p class="text-gray-600 mb-4">
Â  Â  Â  Â  Â  Â  This survey features two ternary plots. On the first plot, please place a point to indicate how you think society **currently balances**
Â  Â  Â  Â  Â  Â  <b class="text-indigo-700">Corporate Rights</b>, <b class="text-indigo-700">Human Rights</b>, and <b class="text-indigo-700">Environmental Rights</b>.
Â  Â  Â  Â  Â  Â  On the second plot, indicate how you think society **will balance** these rights in the year **2075**.
Â  Â  Â  Â  Â  Â  You must log in before submitting.
Â  Â  Â  Â  </p>

Â  Â  Â  Â  <!-- Auth Section -->
Â  Â  Â  Â  <div class="flex flex-col sm:flex-row sm:items-center justify-between space-y-3 sm:space-y-0">
Â  Â  Â  Â  Â  Â  <button class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="signIn()">
Â  Â  Â  Â  Â  Â  Â  Â  Login with Magic Link
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <p id="auth-status" class="px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 shadow-inner bg-gray-200 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Not logged in
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Admin Banner -->
Â  Â  Â  Â  <div id="admin-banner" class="admin-banner hidden mt-4 p-3 rounded-lg border border-green-400 bg-green-100 text-green-800 font-bold">
Â  Â  Â  Â  Â  Â  âœ… Admin Mode Active â€” You can export all responses.
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- EXPORT BUTTON (Admin Only) -->
Â  Â  Â  Â  <button id="export-button" onclick="exportToExcel()" class="hidden mt-4 px-5 py-2 bg-success-green text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-lg">
Â  Â  Â  Â  Â  Â  Export All Responses to CSV (Excel)
Â  Â  Â  Â  </button>
Â  Â  </header>


Â  Â  <div class="grid lg:grid-cols-2 gap-8 mt-8">
Â  Â  Â  <!-- Present Day Plot -->
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-xl">
Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-primary-blue border-b border-indigo-200 pb-3 mb-4">Present Day Values</h2>
Â  Â  Â  Â  <div id="plot-present" class="w-full h-[450px] md:h-[550px]"></div>
Â  Â  Â  Â  <button class="w-full mt-6 px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-primary-hover transition duration-150 shadow-md"
Â  Â  Â  Â  Â  Â  Â  Â  onclick="submitResponse('present')">
Â  Â  Â  Â  Â  Submit Present Response
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <p id="result-present" class="mt-3 text-sm text-gray-600 text-center"></p>
Â  Â  Â  </div>

Â  Â  Â  <!-- Future Plot -->
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-xl">
Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-primary-blue border-b border-indigo-200 pb-3 mb-4">Values in 2075</h2>
Â  Â  Â  Â  <div id="plot-future" class="w-full h-[450px] md:h-[550px]"></div>
Â  Â  Â  Â  <button class="w-full mt-6 px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-primary-hover transition duration-150 shadow-md"
Â  Â  Â  Â  Â  Â  Â  Â  onclick="submitResponse('future')">
Â  Â  Â  Â  Â  Submit Future Response
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <p id="result-future" class="mt-3 text-sm text-gray-600 text-center"></p>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // --- Message Box Implementation (Replaces alert()) ---
Â  Â  function showMessage(text, type = 'info') {
Â  Â  Â  const box = document.createElement('div');
Â  Â  Â  let bgColor, textColor, icon;

Â  Â  Â  switch (type) {
Â  Â  Â  Â  case 'success':
Â  Â  Â  Â  Â  bgColor = 'bg-success-green';
Â  Â  Â  Â  Â  textColor = 'text-white';
Â  Â  Â  Â  Â  icon = 'âœ…';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'error':
Â  Â  Â  Â  Â  bgColor = 'bg-red-600';
Â  Â  Â  Â  Â  textColor = 'text-white';
Â  Â  Â  Â  Â  icon = 'âŒ';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'warning':
Â  Â  Â  Â  Â  bgColor = 'bg-warning-yellow';
Â  Â  Â  Â  Â  textColor = 'text-gray-900';
Â  Â  Â  Â  Â  icon = 'âš ï¸';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'info':
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  bgColor = 'bg-indigo-500';
Â  Â  Â  Â  Â  textColor = 'text-white';
Â  Â  Â  Â  Â  icon = 'â„¹ï¸';
Â  Â  Â  }

Â  Â  Â  // Initial State: Start off-screen right with full width translation and opacity 0
Â  Â  Â  box.className = `p-4 mb-2 rounded-lg shadow-xl font-semibold ${bgColor} ${textColor} opacity-0 transition-all duration-500 transform translate-x-full`;

Â  Â  Â  // Use a container div to help manage width and prevent overlap with scrollbar
Â  Â  Â  box.innerHTML = `<div class="flex items-start space-x-2">${icon}<span class="flex-1">${text}</span></div>`;

Â  Â  Â  const container = document.getElementById('message-box');
Â  Â  Â  container.appendChild(box);

Â  Â  Â  // Slide in and fade up (Transition to final state: opacity 1, translateX(0))
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  box.style.opacity = 1;
Â  Â  Â  Â  box.style.transform = 'translateX(0)';Â 
Â  Â  Â  }, 10);

Â  Â  Â  // Slide out and remove
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  box.style.opacity = 0;
Â  Â  Â  Â  box.style.transform = 'translateY(100px)'; // Slide down and fade out
Â  Â  Â  Â  setTimeout(() => box.remove(), 500); // Wait for fade-out transition
Â  Â  Â  }, 5000);
Â  Â  }


Â  Â  // Admin Email
Â  Â  const ADMIN_EMAIL = "cian.mcadam@ucdconnect.ie";

Â  Â  // Supabase Configuration
Â  Â  const supabaseUrl = "https://ttqxpcstznjxkmznyxis.supabase.co";
Â  Â  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDEyMTgsImV4cCI6MjA3NTAxNzIxOH0.RD-TfpgcLWhBF6G8Y8AeEI9pZTsDKQu-r-fMzvYtgG4";
Â  Â  // WARNING: Exposing the Service Role Key client-side is a security risk
Â  Â  // This is done here only for demonstration in a restricted environment.
Â  Â  const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cXhwY3N0em5qeGttem55eGlzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTQ0MTIxOCwiZXhwIjoyMDc1MDE3MjE4fQ.WT_z-BJRTfu9EqO1Fig515aYF9FUOQGOQQgJ86AjM3Q";

Â  Â  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

Â  Â  let responses = {
Â  Â  Â  present: { a: 1/3, b: 1/3, c: 1/3 },
Â  Â  Â  future: { a: 1/3, b: 1/3, c: 1/3 }
Â  Â  };
Â  Â  let user = null;

Â  Â  // Plot Creation
Â  Â  function makePlot(divId, resultId, label) {
Â  Â  Â  const initial = responses[label.toLowerCase()];

Â  Â  Â  const userDot = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: [initial.a],
Â  Â  Â  Â  b: [initial.b],
Â  Â  Â  Â  c: [initial.c],
Â  Â  Â  Â  marker: { size: 16, color: 'rgb(31, 119, 180)', line: { width: 2, color: 'white' } },
Â  Â  Â  Â  name: "Your Choice"
Â  Â  Â  };

Â  Â  Â  const gridPoints = [];
Â  Â  Â  for (let a = 0; a <= 1; a += 0.01) {
Â  Â  Â  Â  for (let b = 0; b <= 1 - a; b += 0.01) {
Â  Â  Â  Â  Â  const c = 1 - a - b;
Â  Â  Â  Â  Â  const sum = a + b + c;
Â  Â  Â  Â  Â  gridPoints.push({ a: a/sum, b: b/sum, c: c/sum });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  const clickableLayer = {
Â  Â  Â  Â  type: 'scatterternary',
Â  Â  Â  Â  mode: 'markers',
Â  Â  Â  Â  a: gridPoints.map(p => p.a),
Â  Â  Â  Â  b: gridPoints.map(p => p.b),
Â  Â  Â  Â  c: gridPoints.map(p => p.c),
Â  Â  Â  Â  marker: { size: 20, color: 'rgba(0,0,0,0)', opacity: 0 }, // Invisible targets
Â  Â  Â  Â  hoverinfo: 'none'
Â  Â  Â  };

Â  Â  Â  const data = [clickableLayer, userDot];
Â  Â  Â  const layout = {
Â  Â  Â  Â  ternary: {
Â  Â  Â  Â  Â  sum: 1, // Ensure sum constraint
Â  Â  Â  Â  Â  aaxis: { title: "Corporate (A)", min: 0.01, max: 1, tickformat: '.2f', linecolor: '#333' },
Â  Â  Â  Â  Â  baxis: { title: "Human (B)", min: 0.01, max: 1, tickformat: '.2f', linecolor: '#333' },
Â  Â  Â  Â  Â  caxis: { title: "Environmental (C)", min: 0.01, max: 1, tickformat: '.2f', linecolor: '#333' },
Â  Â  Â  Â  Â  bgcolor: '#f9f9f9'
Â  Â  Â  Â  },
Â  Â  Â  Â  title: { text: label + " Values", font: { size: 18, family: 'Inter' } },
Â  Â  Â  Â  margin: { t: 90, r: 0, b: 50, l: 0 }, // INCREASED TOP MARGIN for better spacing
Â  Â  Â  Â  height: document.getElementById(divId).offsetHeight, // Use container height
Â  Â  Â  Â  autosize: true
Â  Â  Â  };

Â  Â  Â  Plotly.newPlot(divId, data, layout, { responsive: true, displayModeBar: false });

Â  Â  Â  const plotDiv = document.getElementById(divId);
Â  Â  Â  const type = label.toLowerCase();

Â  Â  Â  // Update the initial result text
Â  Â  Â  const initialA = initial.a.toFixed(2), initialB = initial.b.toFixed(2), initialC = initial.c.toFixed(2);
Â  Â  Â  document.getElementById(resultId).innerText =
Â  Â  Â  Â  `Initial selection â†’ Corporate: ${initialA}, Human: ${initialB}, Environmental: ${initialC}`;

Â  Â  Â  plotDiv.on('plotly_click', function(eventData) {
Â  Â  Â  Â  const pt = eventData.points[0];
Â  Â  Â  Â  if (!pt || !pt.hasOwnProperty('a') || pt.curveNumber !== 0) return;

Â  Â  Â  Â  const { a, b, c } = pt;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Normalize the values to ensure they sum exactly to 1,
Â  Â  Â  Â  const sum = a + b + c;
Â  Â  Â  Â  const normA = a / sum;
Â  Â  Â  Â  const normB = b / sum;
Â  Â  Â  Â  const normC = c / sum;

Â  Â  Â  Â  responses[type] = { a: normA, b: normB, c: normC };

Â  Â  Â  Â  // Restyle the user dot (index 1 of the data array)
Â  Â  Â  Â  Plotly.restyle(divId, { a: [[normA]], b: [[normB]], c: [[normC]] }, [1]);

Â  Â  Â  Â  // Update display text
Â  Â  Â  Â  document.getElementById(resultId).innerText =
Â  Â  Â  Â  Â  `You chose â†’ Corporate: ${normA.toFixed(2)}, Human: ${normB.toFixed(2)}, Environmental: ${normC.toFixed(2)}`;
Â  Â  Â  });
Â  Â  }

Â  Â  // Initialize plots on load
Â  Â  window.onload = function() {
Â  Â  Â  makePlot("plot-present", "result-present", "Present");
Â  Â  Â  makePlot("plot-future", "result-future", "Future");
Â  Â  Â  // Add a resize listener to ensure Plotly recalculates size on window resize
Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  Plotly.relayout('plot-present', { autosize: true });
Â  Â  Â  Â  Plotly.relayout('plot-future', { autosize: true });
Â  Â  Â  });
Â  Â  };

Â  Â  // Login with Magic Link
Â  Â  async function signIn() {
Â  Â  Â  const email = prompt("Enter your email to receive a login link:");
Â  Â  Â  if (!email) return;

Â  Â  Â  try {
Â  Â  Â  Â  const { error } = await supabase.auth.signInWithOtp({
Â  Â  Â  Â  Â  email,
Â  Â  Â  Â  Â  options: { emailRedirectTo: window.location.href.split(/[?#]/)[0] }
Â  Â  Â  Â  });
Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  showMessage("Login Error: " + error.message, 'error');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showMessage("Success! Check your email for a magic login link to access the survey.", 'success');
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  showMessage("An unexpected error occurred during sign-in.", 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Auth Listener - Controls User Display and Admin Access
Â  Â  supabase.auth.onAuthStateChange((event, session) => {
Â  Â  Â  const authStatus = document.getElementById("auth-status");
Â  Â  Â  const exportButton = document.getElementById("export-button");
Â  Â  Â  const adminBanner = document.getElementById("admin-banner");
Â  Â  Â Â 
Â  Â  Â  authStatus.classList.remove('bg-gray-200', 'text-gray-700', 'bg-warning-yellow', 'text-gray-900', 'bg-green-200', 'text-green-800');

Â  Â  Â  if (session && session.user) {
Â  Â  Â  Â  user = session.user;
Â  Â  Â  Â  const isAdmin = user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();

Â  Â  Â  Â  // 1. Display logged-in user's email
Â  Â  Â  Â  authStatus.innerText = `âœ… Logged in as: ${user.email} ${isAdmin ? '(Admin)' : ''}`;
Â  Â  Â  Â  authStatus.classList.add(isAdmin ? 'bg-green-200' : 'bg-warning-yellow', isAdmin ? 'text-green-800' : 'text-gray-900');

Â  Â  Â  Â  // 2. Control visibility of Export button and Admin Banner
Â  Â  Â  Â  exportButton.classList.toggle("hidden", !isAdmin);
Â  Â  Â  Â  adminBanner.classList.toggle("hidden", !isAdmin);
Â  Â  Â  } else {
Â  Â  Â  Â  user = null;
Â  Â  Â  Â  authStatus.innerText = "Not logged in";
Â  Â  Â  Â  authStatus.classList.add('bg-gray-200', 'text-gray-700');

Â  Â  Â  Â  exportButton.classList.add("hidden");
Â  Â  Â  Â  adminBanner.classList.add("hidden");
Â  Â  Â  }
Â  Â  });

Â  Â  // Submit Response
Â  Â  async function submitResponse(type) {
Â  Â  Â  if (!user) return showMessage("Please log in first.", 'warning');

Â  Â  Â  try {
Â  Â  Â  Â  // 1. Check for existing response
Â  Â  Â  Â  const { data: existing, error: fetchError } = await supabase
Â  Â  Â  Â  Â  .from("responses")
Â  Â  Â  Â  Â  .select("id")
Â  Â  Â  Â  Â  .eq("user_id", user.id)
Â  Â  Â  Â  Â  .eq("type", type);

Â  Â  Â  Â  if (fetchError) {
Â  Â  Â  Â  Â  return showMessage("Error checking previous responses: " + fetchError.message, 'error');
Â  Â  Â  Â  }

Â  Â  Â  Â  if (existing && existing.length > 0) {
Â  Â  Â  Â  Â  return showMessage("âš ï¸ You already submitted for this plot.", 'warning');
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Insert new response
Â  Â  Â  Â  const { error: insertError } = await supabase.from("responses").insert([{
Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  type,
Â  Â  Â  Â  Â  a: responses[type].a,
Â  Â  Â  Â  Â  b: responses[type].b,
Â  Â  Â  Â  Â  c: responses[type].c
Â  Â  Â  Â  }]);

Â  Â  Â  Â  if (insertError) {
Â  Â  Â  Â  Â  showMessage("Error submitting: " + insertError.message, 'error');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showMessage("âœ… Response saved successfully!", 'success');
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  showMessage("An unexpected error occurred during submission.", 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Export to CSV (Admin Only) - Includes the secondary logic check
Â  Â  async function exportToExcel() {
Â  Â  Â  // Secondary check to prevent non-admins from triggering export logic
Â  Â  Â  if (!user || user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase())
Â  Â  Â  Â  return showMessage("ğŸ›‘ Only admin can export data.", 'error');

Â  Â  Â  try {
Â  Â  Â  Â  // Use the Service Role key to bypass Row Level Security (RLS) for the export.
Â  Â  Â  Â  const serviceSupabase = window.supabase.createClient(supabaseUrl, SUPABASE_SERVICE_KEY);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const { data, error } = await serviceSupabase.from("responses").select("*");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (error) return showMessage("Error fetching data: " + error.message, 'error');
Â  Â  Â  Â  if (!data || !data.length) return showMessage("No responses found to export.", 'info');

Â  Â  Â  Â  // CSV generation
Â  Â  Â  Â  const headers = ["user_id", "type", "corporate_a", "human_b", "environmental_c", "created_at"];
Â  Â  Â  Â  const csvContent = data.map(r => [
Â  Â  Â  Â  Â  `"${r.user_id}"`,
Â  Â  Â  Â  Â  r.type,Â 
Â  Â  Â  Â  Â  r.a,Â 
Â  Â  Â  Â  Â  r.b,Â 
Â  Â  Â  Â  Â  r.c,Â 
Â  Â  Â  Â  Â  `"${r.created_at}"`
Â  Â  Â  Â  ].join(",")).join("\n");

Â  Â  Â  Â  const csv = headers.join(",") + "\n" + csvContent;

Â  Â  Â  Â  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  link.download = "ternary_plot_responses_export.csv";
Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  URL.revokeObjectURL(link.href);

Â  Â  Â  Â  showMessage(`âœ… ${data.length} records exported successfully.`, 'success');

Â  Â  Â  } catch (e) {
Â  Â  Â  Â  showMessage("An unexpected error occurred during export.", 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Expose functions globally
Â  Â  window.signIn = signIn;
Â  Â  window.submitResponse = submitResponse;
Â  Â  window.exportToExcel = exportToExcel;
Â  </script>
</body>
</html>
