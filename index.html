<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Ternary Plot Survey with Supabase Login</title>

Â  <!-- Tailwind CSS -->
Â  <script src="https://cdn.tailwindcss.com"></script>

Â  <!-- Plotly -->
Â  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

Â  <!-- Supabase -->
Â  <script src="https://unpkg.com/@supabase/supabase-js"></script>

Â  <style>
Â  Â  /* Custom CSS for responsiveness and aesthetics */
Â  Â  #plot-present, #plot-future {
Â  Â  Â  width: 100%;
Â  Â  Â  min-height: 400px;
Â  Â  Â  /* Ensure plots scale gracefully on smaller screens */
Â  Â  }
Â  Â  #toast {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 20px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  z-index: 1000;
Â  Â  Â  padding: 14px 24px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
Â  Â  Â  display: none;
Â  Â  Â  transition: all 0.5s ease;
Â  Â  }
Â  Â  #toast.show {
Â  Â  Â  display: block;
Â  Â  Â  animation: fadeInOut 4s ease-in-out;
Â  Â  }
Â  Â  @keyframes fadeInOut {
Â  Â  Â  0% { opacity: 0; transform: translate(-50%, -20px); }
Â  Â  Â  10%, 90% { opacity: 1; transform: translate(-50%, 0); }
Â  Â  Â  100% { opacity: 0; transform: translate(-50%, -20px); }
Â  Â  }
Â  </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 sm:p-6 font-sans">
Â  <div id="toast" class="bg-green-600 text-white text-center text-base sm:text-lg"></div>

Â  <div class="max-w-6xl mx-auto">
Â  Â  <header class="bg-white p-6 rounded-xl shadow-lg mb-8">
Â  Â  Â  <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 border-b-2 border-blue-200 pb-3 mb-3">
Â  Â  Â  Â  Ternary Plot Survey
Â  Â  Â  </h1>
Â  Â  Â  <p class="text-gray-600 mb-4 text-sm sm:text-base">
Â  Â  Â  Â  Please indicate how you think society currently balances
Â  Â  Â  Â  <b>Corporate Rights</b>, <b>Human Rights</b>, and <b>Environmental Rights</b>,
Â  Â  Â  Â  and how you think it will balance them in 2075.
Â  Â  Â  Â  You must log in before submitting.
Â  Â  Â  </p>

Â  Â  Â  <button onclick="signIn()"
Â  Â  Â  Â  class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition transform hover:scale-105 shadow-md">
Â  Â  Â  Â  Login with Magic Link
Â  Â  Â  </button>
Â  Â  Â  <p id="auth-status" class="mt-3 text-gray-700 font-semibold">Not logged in</p>

Â  Â  Â  <div id="admin-banner" class="hidden mt-4 p-3 rounded-lg border border-green-400 bg-green-100 text-green-800 font-bold">
Â  Â  Â  Â  âœ… Admin Mode Active â€” You can export all responses.
Â  Â  Â  </div>

Â  Â  Â  <button id="export-button" onclick="exportToExcel()" class="hidden mt-4 px-5 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition transform hover:scale-105 shadow-md">
Â  Â  Â  Â  Export All Responses to CSV (Excel)
Â  Â  Â  </button>
Â  Â  </header>

Â  Â  <div class="grid md:grid-cols-2 gap-8">
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg">
Â  Â  Â  Â  <h2 class="text-xl font-semibold text-blue-800 border-b border-gray-200 pb-2 mb-4">
Â  Â  Â  Â  Â  Present Day Values
Â  Â  Â  Â  </h2>
Â  Â  Â  Â  <div id="plot-present"></div>
Â  Â  Â  Â  <button onclick="submitResponse('present')"
Â  Â  Â  Â  Â  class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.01] shadow-md">
Â  Â  Â  Â  Â  Submit Present Response
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <p id="result-present" class="mt-3 text-gray-600 text-center"></p>
Â  Â  Â  </div>

Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg">
Â  Â  Â  Â  <h2 class="text-xl font-semibold text-blue-800 border-b border-gray-200 pb-2 mb-4">
Â  Â  Â  Â  Â  Values in 2075
Â  Â  Â  Â  </h2>
Â  Â  Â  Â  <div id="plot-future"></div>
Â  Â  Â  Â  <button onclick="submitResponse('future')"
Â  Â  Â  Â  Â  class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.01] shadow-md">
Â  Â  Â  Â  Â  Submit Future Response
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <p id="result-future" class="mt-3 text-gray-600 text-center"></p>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // âœ… Admin setup
Â  Â  const ADMIN_EMAIL = "cian.mcadam@ucdconnect.ie";

Â  Â  // âœ… Supabase credentials (Service Key removed for security as RPC is now used)
Â  Â  const supabaseUrl = "https://szcqmwsnzqdciqablixv.supabase.co";
Â  Â  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Y3Ftd3NuenFkY2lxYWJsaXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzg2OTMsImV4cCI6MjA3NDc1NDY5M30.LE3Qh79LqZacPRrcyvCJOZcJ9FLzADoK5r6dumoNZR0";

Â  Â  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

Â  Â  let user = null;
Â  Â  let responses = { present: { a: 1/3, b: 1/3, c: 1/3 }, future: { a: 1/3, b: 1/3, c: 1/3 } };

Â  Â  function showToast(message, color = "bg-green-600") {
Â  Â  Â  const toast = document.getElementById("toast");
Â  Â  Â  toast.textContent = message;
Â  Â  Â  // Preserve the original Tailwind classes and just add the color
Â  Â  Â  toast.className = `show text-white text-center rounded-lg px-6 py-3 ${color}`;
Â  Â  Â  setTimeout(() => toast.classList.remove("show"), 4000);
Â  Â  }

Â  Â  function makePlot(divId, resultId, label) {
Â  Â  Â  const initial = responses[label.toLowerCase()];
Â  Â  Â  const userDot = {
Â  Â  Â  Â  type: "scatterternary",
Â  Â  Â  Â  mode: "markers",
Â  Â  Â  Â  a: [initial.a], b: [initial.b], c: [initial.c],
Â  Â  Â  Â  marker: { size: 14, color: "blue" },
Â  Â  Â  };

Â  Â  Â  const grid = [];
Â  Â  Â  // Generate points across the triangle surface for click detection
Â  Â  Â  for (let a = 0; a <= 1; a += 0.02) {
Â  Â  Â  Â  for (let b = 0; b <= 1 - a; b += 0.02) {
Â  Â  Â  Â  Â  grid.push({ a, b, c: 1 - a - b });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  const clickLayer = {
Â  Â  Â  Â  type: "scatterternary",
Â  Â  Â  Â  mode: "markers",
Â  Â  Â  Â  a: grid.map(p => p.a),
Â  Â  Â  Â  b: grid.map(p => p.b),
Â  Â  Â  Â  c: grid.map(p => p.c),
Â  Â  Â  Â  marker: { size: 18, color: "rgba(0,0,0,0)" }, // Invisible markers for capturing clicks
Â  Â  Â  Â  hoverinfo: "none",
Â  Â  Â  };

Â  Â  Â  Plotly.newPlot(divId, [clickLayer, userDot], {
Â  Â  Â  Â  ternary: {
Â  Â  Â  Â  Â  aaxis: { title: "Corporate Rights" },
Â  Â  Â  Â  Â  baxis: { title: "Human Rights" },
Â  Â  Â  Â  Â  caxis: { title: "Environmental Rights" },
Â  Â  Â  Â  Â  sum: 1 // Important: ensure axes sum to 1
Â  Â  Â  Â  },
Â  Â  Â  Â  title: label,
Â  Â  Â  Â  // Make plot responsive
Â  Â  Â  Â  responsive: true,
Â  Â  Â  });

Â  Â  Â  const type = label.toLowerCase();
Â  Â  Â  document.getElementById(divId).on("plotly_click", (e) => {
Â  Â  Â  Â  // Plotly returns the ternary coordinates (a, b, c) of the clicked point
Â  Â  Â  Â  const { a, b, c } = e.points[0];
Â  Â  Â  Â  responses[type] = { a, b, c };
Â  Â  Â  Â  // Update the position of the user's dot (which is trace index 1)
Â  Â  Â  Â  Plotly.restyle(divId, { a: [[a]], b: [[b]], c: [[c]] }, [1]);
Â  Â  Â  Â  document.getElementById(resultId).innerText =
Â  Â  Â  Â  Â  `You chose â†’ Corporate: ${a.toFixed(2)}, Human: ${b.toFixed(2)}, Environmental: ${c.toFixed(2)}`;
Â  Â  Â  });
Â  Â  }

Â  Â  window.onload = () => {
Â  Â  Â  makePlot("plot-present", "result-present", "Present");
Â  Â  Â  makePlot("plot-future", "result-future", "Future");
Â  Â  };

Â  Â  async function signIn() {
Â  Â  Â  const email = prompt("Enter your email to receive a login link:");
Â  Â  Â  if (!email) return;
Â  Â  Â  const { error } = await supabase.auth.signInWithOtp({
Â  Â  Â  Â  email,
Â  Â  Â  Â  options: { emailRedirectTo: window.location.href.split(/[?#]/)[0] },
Â  Â  Â  });
Â  Â  Â  // Replaced alert() with showToast()
Â  Â  Â  if (error) showToast("Login Error: " + error.message, "bg-red-600");
Â  Â  Â  else showToast("âœ… Check your email for a magic link to log in.");
Â  Â  }

Â  Â  supabase.auth.onAuthStateChange((_, session) => {
Â  Â  Â  const status = document.getElementById("auth-status");
Â  Â  Â  const exportBtn = document.getElementById("export-button");
Â  Â  Â  const adminBanner = document.getElementById("admin-banner");
Â  Â  Â  const isAdmin = session?.user?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();

Â  Â  Â  if (session) {
Â  Â  Â  Â  user = session.user;
Â  Â  Â  Â  status.innerText = `âœ… Logged in as: ${user.email}`;
Â  Â  Â  Â  exportBtn.style.display = isAdmin ? "block" : "none";
Â  Â  Â  Â  adminBanner.style.display = isAdmin ? "block" : "none";
Â  Â  Â  } else {
Â  Â  Â  Â  user = null;
Â  Â  Â  Â  status.innerText = "Not logged in";
Â  Â  Â  Â  exportBtn.style.display = "none";
Â  Â  Â  Â  adminBanner.style.display = "none";
Â  Â  Â  }
Â  Â  });

Â  Â  async function submitResponse(type) {
Â  Â  Â  // Replaced alert() with showToast()
Â  Â  Â  if (!user) return showToast("Please log in first.", "bg-red-600");
Â  Â  Â  
Â  Â  Â  const { error } = await supabase.from("responses").insert([{
Â  Â  Â  Â  user_id: user.id, type,
Â  Â  Â  Â  a: responses[type].a, b: responses[type].b, c: responses[type].c,
Â  Â  Â  }]);
Â  Â  Â  // Replaced alert() with showToast()
Â  Â  Â  if (error) showToast("Error submitting: " + error.message, "bg-red-600");
Â  Â  Â  else showToast("âœ… Response saved successfully!");
Â  Â  }

Â  Â  // ðŸ“¥ Export (Admin Only) - Now using Supabase RPC for data fetching
Â  Â  async function exportToExcel() {
Â  Â  Â  if (!user || user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
Â  Â  Â  Â  return showToast("ðŸ›‘ Only admin can export data.", "bg-red-600");
Â  Â  Â  }

Â  Â  Â  // âœ… Use the RPC function we created in Supabase SQL Editor:
Â  Â  Â  // This fetches all responses securely, assuming your RPC function handles authentication/roles.
Â  Â  Â  const { data, error } = await supabase.rpc("get_all_responses");

Â  Â  Â  if (error) {
Â  Â  Â  Â  return showToast("Error fetching data: " + error.message, "bg-red-600");
Â  Â  Â  }
Â  Â  Â  if (!data || !data.length) {
Â  Â  Â  Â  return showToast("No responses found.", "bg-yellow-600");
Â  Â  Â  }

Â  Â  Â  // Convert data to CSV, including the 'id' field which is now available via the RPC
Â  Â  Â  const csv = [
Â  Â  Â  Â  ["id", "user_id", "type", "a", "b", "c", "created_at"],
Â  Â  Â  Â  ...data.map((r) => [
Â  Â  Â  Â  Â  r.id,
Â  Â  Â  Â  Â  r.user_id,
Â  Â  Â  Â  Â  r.type,
Â  Â  Â  Â  Â  r.a,
Â  Â  Â  Â  Â  r.b,
Â  Â  Â  Â  Â  r.c,
Â  Â  Â  Â  Â  r.created_at,
Â  Â  Â  Â  ]),
Â  Â  Â  ]
Â  Â  Â  Â  .map((row) => row.join(","))
Â  Â  Â  Â  .join("\n");

Â  Â  Â  // Download CSV
Â  Â  Â  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  link.download = "responses_export.csv";
Â  Â  Â  link.click();

Â  Â  Â  showToast(`âœ… ${data.length} records exported successfully!`);
Â  Â  }
Â  </script>
</body>
</html>
